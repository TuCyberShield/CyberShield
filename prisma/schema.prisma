// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(uuid())
  name         String
  email        String   @unique
  password     String
  role         String   @default("user")
  currentPlan  String   @default("basic") // basic, professional, enterprise
  profilePhoto String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  threats         Threat[]
  emails          Email[]
  connections     Connection[]
  securityHistory SecurityHistory[]
  config          UserConfig?
  subscriptions   Subscription[]
  notifications   Notification[]
  usageLogs       UsageLog[]
  apiKeys         ApiKey[]
  pushSubscriptions PushSubscription[]
  reports         Report[]
  reportSchedules ReportSchedule[]
}

model Plan {
  id          String   @id @default(uuid())
  name        String   @unique // "basic", "professional", "enterprise"
  displayName String   // "Plan BÃ¡sico"
  price       Float
  features    String   // JSON string of features
  limits      String   // JSON string of limits
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  subscriptions Subscription[]
}

model Subscription {
  id        String    @id @default(uuid())
  userId    String
  planId    String
  status    String    @default("active") // active, cancelled, expired
  startDate DateTime  @default(now())
  endDate   DateTime?
  autoRenew Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan Plan @relation(fields: [planId], references: [id])
  
  @@unique([userId, planId])
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  type      String   // "threat", "security", "system", "plan"
  title     String
  message   String
  severity  String   @default("info") // low, medium, high, critical, info
  read      Boolean  @default(false)
  link      String?  // Optional link to related item
  createdAt DateTime @default(now())
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model UsageLog {
  id        String   @id @default(uuid())
  userId    String
  action    String   // "url_scan", "email_scan", "invoice_scan", "traffic_analysis"
  details   String?  // JSON string with additional details
  timestamp DateTime @default(now())
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Threat {
  id          String   @id @default(uuid())
  type        String
  origin      String
  description String
  severity    String   // low, medium, high, critical
  status      String   // blocked, quarantine, pending
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
}

model Email {
  id        String   @id @default(uuid())
  sender    String
  subject   String
  content   String?
  analyzed  Boolean  @default(false)
  riskLevel String?  // low, medium, high
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
}

model Connection {
  id        String   @id @default(uuid())
  ipAddress String
  port      Int
  protocol  String
  status    String   // active, blocked, monitoring
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
}

model SecurityHistory {
  id     String   @id @default(uuid())
  userId String
  user   User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  score  Int
  date   DateTime @default(now())
}

model UserConfig {
  id            String   @id @default(uuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  theme         String   @default("dark")
  language      String   @default("es")
  notifications Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model ApiKey {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String   // User-friendly name like "Production API", "Dev Server"
  key         String   @unique // The actual API key (hashed)
  lastUsedAt  DateTime?
  isActive    Boolean  @default(true)
  rateLimit   Int      @default(100) // Requests per minute
  createdAt   DateTime @default(now())
  expiresAt   DateTime? // Optional expiration
  
  @@index([userId])
  @@index([key])
}

model PushSubscription {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  endpoint    String   @unique
  p256dh      String   // Public key
  auth        String   // Auth secret
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  
  @@index([userId])
}

model Report {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type        String   // weekly, monthly, custom
  period      String   // "2025-12", "2025-W48", etc.
  status      String   // generating, completed, failed
  fileUrl     String?  // URL to PDF file
  emailSent   Boolean  @default(false)
  createdAt   DateTime @default(now())
  
  stats       Json     // Summary statistics
  
  @@index([userId, createdAt])
}

model ReportSchedule {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  frequency   String   // weekly, monthly
  dayOfWeek   Int?     // 0-6 for weekly (0 = Sunday)
  dayOfMonth  Int?     // 1-31 for monthly
  emailTo     String[] // Recipients
  isActive    Boolean  @default(true)
  lastRun     DateTime?
  nextRun     DateTime?
  createdAt   DateTime @default(now())
  
  @@index([userId])
  @@index([isActive, nextRun])
}
